# 编排调度系统

## 概述

编排调度系统负责任务的分解、调度和执行控制，核心组件包括：

- **DAG Scheduler** - 基于拓扑排序的任务调度器
- **State Machine** - Step 生命周期状态机
- **Router** - 能力路由器
- **Orchestrator** - 编排控制器

## 核心数据流

```
TaskSpec
    │
    ▼
┌─────────────────────────────────────────────────────────────────┐
│                    PlannerAgent                                  │
│                         │                                        │
│                         ▼                                        │
│              生成 Steps with deps[] (DAG 结构)                   │
└─────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────┐
│                    DAG Scheduler                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │          层级化 Kahn 算法                                 │   │
│  │  1. 构建依赖图                                           │   │
│  │  2. 计算入度                                             │   │
│  │  3. 拓扑排序 → [[L0], [L1], ..., [Ln]]                  │   │
│  │  4. 层内并行、层间串行                                   │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Layer Execution                               │
│  Level 0: [Step A, Step B]        ← 并行执行                    │
│      │                                                          │
│      ▼                                                          │
│  Level 1: [Step C, Step D, Step E] ← 并行执行                   │
│      │                                                          │
│      ▼                                                          │
│  Level 2: [Step F]                 ← 等待 C,D,E 完成后执行      │
└─────────────────────────────────────────────────────────────────┘
```

## 文档索引

| 文档 | 内容 |
|------|------|
| [DAG 调度器](./dag-scheduler.md) | 层级化 Kahn 算法、DAG 结构、上下文注入 |
| [Step 生命周期](./step-lifecycle.md) | 状态机、状态转换、生命周期管理 |
| [完整执行流程](./execution-flow.md) | 端到端执行流程、协商→规划→执行→验证 |

## 快速参考

### DAG 依赖模式

| 模式 | 结构 | 典型场景 |
|------|------|----------|
| **线性链** | A → B → C | 思维链推理、顺序审核 |
| **扇入** | A, B, C → D | 多源数据整合、综合评估 |
| **扇出** | A → B, C, D | 并行分析、数据分发 |
| **菱形** | A → {B, C} → D | Map-Reduce、多工具并行后汇总 |

### Step 状态

```
PENDING → WAITING_DEPS → LEASED → RUNNING → SUCCEEDED
                              │       │
                              │       ├─→ FAILED_RETRYABLE → RETRYING
                              │       ├─→ FAILED_RESOURCE → SWITCHING
                              │       ├─→ FAILED_FATAL → FAILED
                              │       └─→ NEEDS_USER
                              │
                              └─→ LEASE_TIMEOUT → PENDING
```

### 性能指标

| 指标 | 目标值 |
|------|--------|
| 调度延迟 | <10ms（500 任务规模） |
| 时间复杂度 | O(V + E) |
| 最优层数 | DAG 最长路径节点数（Mirsky 定理） |
