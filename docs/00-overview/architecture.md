# 逻辑架构

## 分层视图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           UI / Client Layer                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │   Web Console   │  │    SDK/CLI      │  │   WebSocket     │             │
│  │  (任务/证据/回放) │  │  (提交/订阅)    │  │   (实时事件)    │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Control Plane (控制面)                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │  Task API    │  │ Orchestrator │  │    Router    │  │  Scheduler   │   │
│  │  (OpenAPI)   │  │  (状态机)     │  │  (能力路由)   │  │  (并发控制)   │   │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   │
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                    Policy Engine (权限/配额/策略)                      │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Agent Plane (智能体面 - AgentScope)                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │PlannerAgent  │  │TaskExecutor  │  │ CriticAgent  │  │Coordinator   │   │
│  │  (规划)      │  │   (执行)     │  │  (验收)      │  │  (仲裁)      │   │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   │
│                                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                     │
│  │ Negotiator   │  │ VotingAgent  │  │   Memory     │                     │
│  │  (意图协商)   │  │  (投票验证)  │  │  (记忆系统)  │                     │
│  └──────────────┘  └──────────────┘  └──────────────┘                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Resource Plane (资源面)                               │
│  ┌──────────────────────┐  ┌──────────────────────┐  ┌─────────────────┐  │
│  │  Capability Registry │  │  Resource Registry   │  │  Lease Manager  │  │
│  │     (能力注册)        │  │    (资源登记)         │  │   (租约管理)    │  │
│  └──────────────────────┘  └──────────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       Execution Plane (执行面)                               │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐           │
│  │ Browser    │  │  Mobile    │  │ Container  │  │    VM      │           │
│  │  Agent     │  │   Agent    │  │   Agent    │  │   Agent    │           │
│  └──────┬─────┘  └──────┬─────┘  └──────┬─────┘  └──────┬─────┘           │
│         │               │               │               │                  │
│  ┌──────▼─────┐  ┌──────▼─────┐  ┌──────▼─────┐  ┌──────▼─────┐           │
│  │ CDP/MCP    │  │   Appium   │  │    K8s     │  │ SSH/RDP    │           │
│  │ WebDriver  │  │  Driver    │  │   Client   │  │   VNC      │           │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘           │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Storage Layer (存储层)                               │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐           │
│  │ PostgreSQL │  │   Redis    │  │   Kafka    │  │     S3     │           │
│  │ + pgvector │  │  (Cache)   │  │  (Queue)   │  │ (Evidence) │           │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘           │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 核心数据流

```
1. 用户提交 Task
        │
        ▼
2. NegotiatorAgent 意图协商（按需）
        │
        ▼ TaskSpec
3. PlannerAgent 生成 Steps (DAG 结构)
        │
        ▼ DAG[Steps]
4. DAG Scheduler 拓扑排序 → 层级化执行
        │
        ▼
5. Router 为每个 Step 选择 Specialist Agent
        │
        ▼
6. Lease Manager 分配资源租约
        │
        ▼
7. TaskExecutor 发起 AgentCall
        │
        ▼
8. Specialist Agent 执行并返回结果
        │
        ▼
9. Verification (Single/Voting/Adversarial)
        │
        ▼
10. CriticAgent 验收 → accept/retry/replan
        │
        ▼
11. Memory System 更新执行经验
        │
        ▼
12. 返回 Task Result + Evidence
```

## 组件职责

### Control Plane

| 组件 | 职责 |
|------|------|
| **Task API** | 任务 CRUD、时间线查询、证据访问 |
| **Orchestrator** | Step 状态机管理、执行流程控制 |
| **Router** | 根据 capability 选择目标 Agent |
| **Scheduler** | 并发控制、队列管理、优先级调度 |
| **Policy Engine** | 权限、配额、网络/文件策略、密钥域 |

### Agent Plane

| Agent | 职责 |
|-------|------|
| **PlannerAgent** | 生成/更新 Steps（计划） |
| **TaskExecutorAgent** | 调用 Specialist Agents（不直连工具） |
| **CriticAgent** | 验收/纠偏（accept/retry/switch/replan） |
| **CoordinatorAgent** | 并行子任务合并、冲突仲裁 |
| **NegotiatorAgent** | 意图解析与协商对话 |
| **VotingAgent** | 多 Agent 投票与对抗验证 |

### Resource Plane

| 组件 | 职责 |
|------|------|
| **Capability Registry** | Agent 能力注册与发现 |
| **Resource Registry** | 资源登记（浏览器/手机/VM/容器） |
| **Lease Manager** | 租约分配/续租/回收 |

### Execution Plane

| Agent | 执行标准 |
|-------|---------|
| **BrowserAgent** | CDP/MCP + WebDriver |
| **MobileAgent** | Appium (UiAutomator2/XCUITest) |
| **ContainerAgent** | Kubernetes Job/Pod |
| **VMDesktopAgent** | SSH/RDP/WinRM/VNC |
